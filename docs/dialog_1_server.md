# Детальная постановка задачи для первого этапа: Настройка сервера и инфраструктуры

## Цель
Подготовить серверную инфраструктуру для персональной системы индексации документов с поддержкой RAG. Настроить базовую безопасность, установить необходимое программное обеспечение и создать структуру каталогов для последующей разработки.

## Задачи

### 1. Базовая настройка сервера ✅
- Подключиться к серверу (IP: 109.107.189.224) по SSH ✅
- Настроить безопасный доступ (SSH-ключи, отключить парольную аутентификацию) ✅
- Обновить пакеты и установить базовые утилиты (git, curl, wget, htop, etc.) ✅
- Настроить брандмауэр UFW (разрешить только SSH, HTTP/HTTPS) ✅
- Настроить временную зону и NTP-синхронизацию ✅

### 2. Установка Docker и Docker Compose ✅
- Установить Docker Engine ✅
- Установить Docker Compose ✅
- Настроить Docker для запуска от непривилегированного пользователя ✅
- Создать базовую сеть Docker для взаимодействия контейнеров ✅
- Проверить правильность установки запуском тестового контейнера ✅

### 3. Создание структуры каталогов ✅
- Создать основную структуру каталогов согласно документу structure_of_the_project.md ✅
- Настроить правильные права доступа к каталогам ✅
- Создать .gitignore для исключения конфиденциальных данных ✅

### 4. Настройка базовых конфигурационных файлов ✅
- Создать шаблоны .env файлов для разных сервисов ✅
- Настроить settings.yml с основными параметрами проекта ✅
- Документировать каждый конфигурационный параметр ✅

### 5. Подготовка мониторинга и логирования
- Настроить logrotate для ротации логов
- Создать структуру каталогов для логов
- Настроить базовый мониторинг сервера (CPU, RAM, диск)

## Технические детали
- Сервер: Linux, 8 GB RAM, 120 GB SSD
- Учетные данные будут предоставлены отдельно
- Для Docker контейнеров использовать latest тэги только на этапе разработки
- Для продакшена зафиксировать версии всех образов
- Обеспечить возможность резервного копирования всех конфигураций

## Ожидаемые результаты
1. Сервер с безопасным SSH-доступом и настроенным брандмауэром ✅
2. Установленные Docker и Docker Compose ✅
3. Созданная структура каталогов проекта ✅
4. Базовые конфигурационные файлы ✅
5. Настроенная система логирования

## Важные моменты
- Все шаги должны быть документированы в README.md
- Обратить особое внимание на безопасность (согласно security_guideline_document.md)
- Обеспечить идемпотентность всех скриптов установки и настройки

## Прогресс выполнения

### Шаг 1: Настройка базовой безопасности сервера ✅

#### Выполненные задачи:
- Подключение к серверу выполнено успешно
- Сгенерированы SSH-ключи для безопасного доступа
- Создан скрипт `setup_server_security.sh` для настройки безопасности сервера

#### Скрипт `setup_server_security.sh` выполняет:
- Обновление системы и установку базовых утилит безопасности
- Настройку автоматических обновлений безопасности
- Настройку временной зоны и синхронизации времени
- Настройку fail2ban для защиты от брутфорс-атак
- Настройку брандмауэра UFW с разрешенными SSH, HTTP, HTTPS
- Отключение парольной аутентификации SSH
- Создание непривилегированного пользователя raguser с sudo-правами
- Настройку SSH-доступа для пользователя raguser с использованием SSH-ключа

#### Инструкция по использованию:
```bash
# На сервере
chmod +x /path/to/setup_server_security.sh
sudo ./setup_server_security.sh
```

После выполнения скрипта вы сможете подключиться к серверу как пользователь raguser используя созданный SSH-ключ:
```bash
ssh raguser@109.107.189.224
```

### Шаг 2: Установка Docker и Docker Compose ✅

#### Выполненные задачи:
- Создан скрипт `install_docker.sh` для установки Docker и Docker Compose
- Docker Engine успешно установлен
- Docker Compose успешно установлен
- Настроены права для запуска Docker от пользователя raguser
- Создана сеть Docker ragnet для взаимодействия контейнеров
- Проверка установки выполнена успешно

#### Скрипт `install_docker.sh` выполняет:
- Установку необходимых зависимостей
- Добавление официального репозитория Docker
- Установку Docker Engine
- Установку Docker Compose
- Добавление пользователя raguser в группу docker для запуска без sudo
- Создание docker сети ragnet для взаимодействия контейнеров
- Проверку установки запуском тестового контейнера hello-world

#### Инструкция по использованию:
```bash
# На сервере
chmod +x /path/to/install_docker.sh
sudo ./install_docker.sh
```

### Шаг 3: Создание структуры каталогов ✅

#### Выполненные задачи:
- Создан скрипт `create_directory_structure.sh` для создания структуры каталогов проекта
- Создана основная структура каталогов согласно документу structure_of_the_project.md
- Настроены правильные права доступа к каталогам
- Создан .gitignore для исключения конфиденциальных данных

#### Скрипт `create_directory_structure.sh` выполняет:
- Создание основной структуры каталогов согласно документу structure_of_the_project.md
- Создание пустых лог-файлов
- Создание файла README.md с описанием проекта
- Создание .gitignore для исключения конфиденциальных данных
- Настройку правильных прав доступа к каталогам

#### Инструкция по использованию:
```bash
# На сервере
chmod +x /path/to/create_directory_structure.sh
# Запуск от пользователя raguser
sudo -u raguser /path/to/create_directory_structure.sh
# Или запуск от root с автоматической установкой прав
sudo /path/to/create_directory_structure.sh
```

### Шаг 4: Настройка базовых конфигурационных файлов ✅

#### Выполненные задачи:
- Создан скрипт `create_config_files.sh` для создания базовых конфигурационных файлов
- Созданы шаблоны .env файлов для разных сервисов
- Создан settings.yml с основными параметрами проекта
- Создана документация к конфигурационным файлам

#### Скрипт `create_config_files.sh` выполняет:
- Создание шаблона .env файла (.env.example) с настройками для различных сервисов
- Создание settings.yml файла с основными параметрами проекта
- Создание docker-compose.yml для определения контейнеров проекта
- Создание документации к конфигурационным файлам в docs/config-guide.md
- Настройку правильных прав доступа к конфигурационным файлам

#### Инструкция по использованию:
```bash
# На сервере
chmod +x /path/to/create_config_files.sh
# Запуск от пользователя raguser
sudo -u raguser /path/to/create_config_files.sh
# Или запуск от root с автоматической установкой прав
sudo /path/to/create_config_files.sh

# После создания файлов нужно скопировать .env.example в .env и настроить значения
cp /home/raguser/rag-project/config/.env.example /home/raguser/rag-project/config/.env
```

### Шаг 5: Подготовка мониторинга и логирования

#### Подготовленные задачи:
- Создан скрипт `setup_monitoring.sh` для настройки мониторинга и логирования

#### Скрипт `setup_monitoring.sh` выполняет:
- Установку необходимых пакетов для мониторинга (logrotate, bc, sysstat)
- Настройку logrotate для ротации логов проекта
- Создание скрипта для мониторинга системных ресурсов (CPU, RAM, диск)
- Создание скрипта для проверки здоровья сервисов
- Настройку cron для регулярного запуска скриптов мониторинга
- Настройку правильных прав доступа к скриптам мониторинга

#### Инструкция по использованию:
```bash
# На сервере
chmod +x /path/to/setup_monitoring.sh
sudo ./setup_monitoring.sh
```

После настройки мониторинга:
- Скрипт мониторинга системных ресурсов будет запускаться каждые 5 минут
- Скрипт проверки здоровья сервисов будет запускаться каждые 10 минут
- Логи будут ротироваться ежедневно и храниться в сжатом виде в течение 14 дней
- Результаты мониторинга будут доступны в виде HTML-отчета
